#!/usr/bin/env -S uv run --quiet --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "jinja2",
# ]
# ///
"""
Theme Switching System

Converts theme JSON files to application configs using Jinja2 templates.
Outputs to chezmoi source directory (~/.local/share/chezmoi/dot_config)

Usage: theme-switch [THEME]
"""

import asyncio
import json
import subprocess
import sys
from pathlib import Path

from jinja2 import BaseLoader, Environment

# =============================================================================
# Configuration
# =============================================================================

CHEZMOI_SOURCE_DIR = Path.home() / ".local/share/chezmoi/dot_config"
THEME_DIR = CHEZMOI_SOURCE_DIR / "themes"
TEMPLATE_DIR = CHEZMOI_SOURCE_DIR / "theme-templates"
WALLPAPER_DIR = Path.home() / ".config/wallpapers"

DEFAULT_THEME = "everforest"


# =============================================================================
# Color Conversion Filters
# =============================================================================


def strip_hash(color: str) -> str:
    """Remove # prefix from hex color."""
    return color.lstrip("#")


def hex_to_rgb(color: str) -> tuple[int, int, int]:
    """Convert hex color to RGB tuple."""
    h = strip_hash(color)
    return (int(h[0:2], 16), int(h[2:4], 16), int(h[4:6], 16))


def opacity_to_hex(opacity: float) -> str:
    """Convert opacity (0.0-1.0) to hex alpha (00-ff)."""
    return f"{int(opacity * 255):02x}"


# Jinja2 Filters


def filter_hex(color: str) -> str:
    """Return color as #rrggbb."""
    h = strip_hash(color)
    return f"#{h[:6]}"


def filter_hex_alpha(color: str, opacity: float = 1.0) -> str:
    """Return color as #rrggbbaa."""
    h = strip_hash(color)
    alpha = opacity_to_hex(opacity)
    return f"#{h[:6]}{alpha}"


def filter_rgb(color: str) -> str:
    """Return color as rgb(r, g, b)."""
    r, g, b = hex_to_rgb(color)
    return f"rgb({r}, {g}, {b})"


def filter_rgba(color: str, opacity: float = 1.0) -> str:
    """Return color as rgba(r, g, b, a)."""
    r, g, b = hex_to_rgb(color)
    return f"rgba({r}, {g}, {b}, {opacity:.2f})"


def filter_rgb_values(color: str) -> str:
    """Return just the RGB values: r, g, b."""
    r, g, b = hex_to_rgb(color)
    return f"{r}, {g}, {b}"


def filter_hypr_rgb(color: str) -> str:
    """Return color as rgb(rrggbb) for Hyprland."""
    h = strip_hash(color)
    return f"rgb({h[:6]})"


def filter_hypr_rgba(color: str, opacity: float = 1.0) -> str:
    """Return color as rgba(rrggbbaa) for Hyprland."""
    h = strip_hash(color)
    alpha = opacity_to_hex(opacity)
    return f"rgba({h[:6]}{alpha})"


def filter_strip(color: str) -> str:
    """Return raw hex without #."""
    return strip_hash(color)


# =============================================================================
# Template Processing
# =============================================================================


def create_jinja_env() -> Environment:
    """Create Jinja2 environment with custom delimiters and filters."""
    env = Environment(
        loader=BaseLoader(),
        variable_start_string="{<",
        variable_end_string=">}",
        block_start_string="{%<",
        block_end_string=">%}",
        comment_start_string="{#<",
        comment_end_string=">#}",
        keep_trailing_newline=True,
    )

    # Register filters
    env.filters["hex"] = filter_hex
    env.filters["hex_alpha"] = filter_hex_alpha
    env.filters["rgb"] = filter_rgb
    env.filters["rgba"] = filter_rgba
    env.filters["rgb_values"] = filter_rgb_values
    env.filters["hypr_rgb"] = filter_hypr_rgb
    env.filters["hypr_rgba"] = filter_hypr_rgba
    env.filters["strip"] = filter_strip

    return env


def load_theme(theme_name: str) -> dict:
    """Load theme JSON file."""
    theme_file = THEME_DIR / f"{theme_name}.json"

    if not theme_file.exists():
        print(f"Error: Theme not found: {theme_name}")
        print("Available themes:")
        for f in THEME_DIR.glob("*.json"):
            print(f"  {f.stem}")
        sys.exit(1)

    with open(theme_file) as f:
        return json.load(f)


def process_templates(env: Environment, theme_data: dict) -> None:
    """Process all .theme template files."""
    for template_file in TEMPLATE_DIR.rglob("*.theme"):
        # Calculate output path
        # theme-templates/waybar/style.css.theme -> waybar/style.css.tmpl
        relative = template_file.relative_to(TEMPLATE_DIR)
        output_name = relative.with_suffix(".tmpl")
        output_path = CHEZMOI_SOURCE_DIR / output_name

        print(f"    {relative} -> {output_name}")

        # Create output directory if needed
        output_path.parent.mkdir(parents=True, exist_ok=True)

        # Read and process template
        template_content = template_file.read_text()
        template = env.from_string(template_content)
        result = template.render(**theme_data)

        # Write output
        output_path.write_text(result)


# =============================================================================
# Application Reloading (Async)
# =============================================================================


async def run_async(cmd: list[str]) -> bool:
    """Run command asynchronously, return True if successful."""
    try:
        proc = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.DEVNULL,
            stderr=asyncio.subprocess.DEVNULL,
        )
        await proc.wait()
        return proc.returncode == 0
    except (OSError, FileNotFoundError):
        return False


async def is_running(process: str) -> bool:
    """Check if a process is running."""
    proc = await asyncio.create_subprocess_exec(
        "pgrep", "-x", process,
        stdout=asyncio.subprocess.DEVNULL,
        stderr=asyncio.subprocess.DEVNULL,
    )
    await proc.wait()
    return proc.returncode == 0


async def restart_app(
    name: str,
    process: str,
    cmd: list[str],
    start_if_not_running: bool = False,
) -> None:
    """Kill (if running) and restart an application."""
    was_running = await is_running(process)
    if was_running:
        # -w waits for process to die before returning
        await run_async(["killall", "-w", process])
        subprocess.Popen(
            cmd,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            start_new_session=True,
        )
        print(f"    {name} restarted")
    elif start_if_not_running:
        subprocess.Popen(
            cmd,
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            start_new_session=True,
        )
        print(f"    {name} started")


async def reload_hyprland() -> None:
    """Reload Hyprland config."""
    if await is_running("Hyprland"):
        await run_async(["hyprctl", "reload"])
        print("    Hyprland reloaded")


async def reload_waybar() -> None:
    """Restart Waybar."""
    await restart_app("Waybar", "waybar", ["waybar"], start_if_not_running=True)


async def reload_swaync() -> None:
    """Restart SwayNC."""
    await restart_app("SwayNC", "swaync", ["swaync"], start_if_not_running=True)


async def reload_elephant() -> None:
    """Restart Elephant."""
    await restart_app("Elephant", "elephant", ["elephant"], start_if_not_running=True)


async def set_wallpaper(theme_data: dict) -> None:
    """Set wallpaper if specified in theme."""
    wallpaper = theme_data.get("_wallpaper")
    if not wallpaper:
        return

    wallpaper_path = WALLPAPER_DIR / wallpaper
    if not wallpaper_path.exists():
        print(f"    Warning: Wallpaper not found: {wallpaper}")
        return

    if await is_running("awww-daemon"):
        await run_async(["awww", "img", str(wallpaper_path)])
        print(f"    Wallpaper set: {wallpaper}")
    else:
        print("    Warning: awww-daemon not running, skipping wallpaper")


async def set_gtk_theme(theme_data: dict) -> None:
    """Set GTK color scheme (dark/light) for libadwaita apps."""
    scheme = theme_data.get("_gtk_color_scheme")
    if not scheme:
        return

    await run_async([
        "gsettings", "set", "org.gnome.desktop.interface",
        "color-scheme", scheme
    ])
    print(f"    GTK color scheme: {scheme}")


async def reload_all(theme_data: dict) -> None:
    """Reload all applications in parallel."""
    print("==> Reloading applications...")
    await asyncio.gather(
        reload_hyprland(),
        reload_waybar(),
        reload_swaync(),
        reload_elephant(),
        set_wallpaper(theme_data),
        set_gtk_theme(theme_data),
    )


# =============================================================================
# Main
# =============================================================================


async def main() -> None:
    theme_name = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_THEME

    print(f"==> Loading theme: {theme_name}")
    theme_data = load_theme(theme_name)

    # Add theme name to data for templates
    theme_data["_theme_name"] = theme_name

    print("==> Processing theme templates...")
    env = create_jinja_env()
    process_templates(env, theme_data)

    # Update active theme symlink
    active_link = THEME_DIR / "active.json"
    active_link.unlink(missing_ok=True)
    active_link.symlink_to(f"{theme_name}.json")

    print("==> Applying chezmoi...")
    proc = await asyncio.create_subprocess_exec("chezmoi", "apply")
    await proc.wait()

    await reload_all(theme_data)

    print(f"âœ“ Theme switched to: {theme_name}")


if __name__ == "__main__":
    asyncio.run(main())
