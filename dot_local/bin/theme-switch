#!/usr/bin/env bash
set -e

# ============================================================================
# Theme Switching System
# Converts theme files to application configs using templates
# Outputs to chezmoi source directory (~/.local/share/chezmoi/dot_config)
# Usage: theme-switch [THEME]
# ============================================================================

THEME=${1:-carbonfox}
CHEZMOI_SOURCE_DIR="$HOME/.local/share/chezmoi/dot_config"
THEME_FILE="$CHEZMOI_SOURCE_DIR/themes/${THEME}.conf"
TEMPLATE_DIR="$CHEZMOI_SOURCE_DIR/theme-templates"
OUTPUT_DIR="$CHEZMOI_SOURCE_DIR"

if [[ ! -f "$THEME_FILE" ]]; then
    echo "Error: Theme not found: $THEME"
    echo "Available themes:"
    ls -1 "$CHEZMOI_SOURCE_DIR/themes" | grep -v "active" | sed 's/.conf$//'
    exit 1
fi

# ============================================================================
# Color Conversion Functions
# ============================================================================

# Convert hex to RGB (comma-separated)
# Usage: hex_to_rgb "3ddbd9" -> "61, 219, 217"
hex_to_rgb() {
    local hex=$1
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    echo "$r, $g, $b"
}

# Convert opacity (0-100) to hex alpha (00-ff)
# Usage: opacity_to_hex 93 -> "ee"
opacity_to_hex() {
    local opacity=$1
    printf '%02x' $(( opacity * 255 / 100 ))
}

# Convert opacity (0-100) to decimal (0.00-1.00)
# Usage: opacity_to_decimal 93 -> "0.93"
opacity_to_decimal() {
    local opacity=$1
    # Pure bash arithmetic (no bc dependency)
    printf "0.%02d" "$opacity"
}

# Generate color in various formats
# Usage: color_format "3ddbd9" "css_rgba" 93
color_format() {
    local hex=$1
    local format=$2
    local opacity=${3:-100}

    case $format in
        "hex")
            # Simple hex: #3ddbd9
            echo "#${hex}"
            ;;
        "hex_alpha")
            # Hex with alpha: #3ddbd9ee
            local alpha=$(opacity_to_hex $opacity)
            echo "#${hex}${alpha}"
            ;;
        "hypr_rgb")
            # Hyprland RGB: rgb(3ddbd9)
            echo "rgb(${hex})"
            ;;
        "hypr_rgba")
            # Hyprland RGBA: rgba(3ddbd9ee)
            local alpha=$(opacity_to_hex $opacity)
            echo "rgba(${hex}${alpha})"
            ;;
        "css_rgb")
            # CSS RGB: rgb(61, 219, 217)
            echo "rgb($(hex_to_rgb $hex))"
            ;;
        "css_rgba")
            # CSS RGBA: rgba(61, 219, 217, 0.93)
            local alpha=$(opacity_to_decimal $opacity)
            echo "rgba($(hex_to_rgb $hex), $alpha)"
            ;;
        "rgb_only")
            # Just RGB values: 61, 219, 217
            hex_to_rgb $hex
            ;;
        *)
            echo "Error: Unknown format: $format" >&2
            return 1
            ;;
    esac
}

# ============================================================================
# Variable Resolution
# ============================================================================

# Declare associative array for theme variables
declare -A THEME_VARS

# Load theme file into associative array
load_theme() {
    local theme_file=$1

    while IFS='=' read -r key value; do
        # Skip empty lines and comments
        [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue

        # Trim whitespace
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)

        THEME_VARS["$key"]="$value"
    done < "$theme_file"
}

# Resolve variable (follows references like ACCENT -> PALETTE_ACCENT -> 3ddbd9)
# Usage: resolve_var "WM_BORDER_ACTIVE_COLOR" -> "3ddbd9"
resolve_var() {
    local var_name=$1
    local value="${THEME_VARS[$var_name]}"
    local depth=0
    local max_depth=10

    # Follow variable references
    while [[ -n "${THEME_VARS[$value]}" ]] && [[ $depth -lt $max_depth ]]; do
        value="${THEME_VARS[$value]}"
        ((depth++))
    done

    if [[ $depth -eq $max_depth ]]; then
        echo "Error: Circular reference detected for $var_name" >&2
        return 1
    fi

    echo "$value"
}

# ============================================================================
# Template Expansion
# ============================================================================

# Expand template with variable substitution
# Supports: {{VAR}}, {{VAR:format}}, {{VAR:format:OPACITY_VAR}}
expand_template() {
    local template_file=$1
    local content=$(cat "$template_file")

    # Find and replace theme variable patterns: {{VAR}} or {{VAR:format:opacity}}
    #
    # Theme variables use UPPERCASE_WITH_UNDERSCORES (e.g., {{WM_BORDER_COLOR}})
    # Chezmoi templates use lowercase/mixed case (e.g., {{ .graphics }}, {{ if eq ... }})
    #
    # The regex only matches patterns starting with an uppercase letter.
    # Theme vars: {{VAR}}, {{VAR:format}}, {{VAR:format:OPACITY}}
    # Format specifiers can be lowercase (e.g., hypr_rgba, css_rgb).
    # This preserves chezmoi templates which start with spaces, dots, or keywords.
    while [[ $content =~ \{\{([A-Z][A-Za-z0-9_:]*)\}\} ]]; do
        local full_match="${BASH_REMATCH[0]}"
        local var_spec="${BASH_REMATCH[1]}"

        # Parse: VAR or VAR:format or VAR:format:opacity
        IFS=':' read -r var_name format opacity_var <<< "$var_spec"

        # Trim whitespace
        var_name=$(echo "$var_name" | xargs)
        format=$(echo "$format" | xargs)
        opacity_var=$(echo "$opacity_var" | xargs)

        # Resolve the color variable
        local color_hex=$(resolve_var "$var_name")

        if [[ -z "$color_hex" ]]; then
            echo "Error: Variable not found: $var_name" >&2
            content="${content//$full_match/ERROR_${var_name}_NOT_FOUND}"
            continue
        fi

        local value=""

        if [[ -z "$format" ]]; then
            # Simple case: {{ACCENT}} -> #3ddbd9
            value="#${color_hex}"
        else
            # Resolve opacity variable if provided
            local opacity=100
            if [[ -n "$opacity_var" ]]; then
                opacity=$(resolve_var "$opacity_var")
                if [[ -z "$opacity" ]]; then
                    echo "Error: Opacity variable not found: $opacity_var" >&2
                    opacity=100
                fi
            fi

            # Format the color
            value=$(color_format "$color_hex" "$format" "$opacity")
        fi

        # Replace first occurrence
        content="${content/$full_match/$value}"
    done

    echo "$content"
}

# ============================================================================
# Main Script
# ============================================================================

echo "==> Loading theme: $THEME"
load_theme "$THEME_FILE"

# Update active theme symlink
ln -sf "${THEME}.conf" "$CHEZMOI_SOURCE_DIR/themes/active"

# Process all theme templates
echo "==> Processing theme templates..."

find "$TEMPLATE_DIR" -name "*.theme" -type f | while read template; do
    # Calculate output path
    # theme-templates/waybar/style.css.theme -> waybar/style.css.tmpl
    relative=${template#$TEMPLATE_DIR/}
    base_path="${relative%.theme}"
    output="$OUTPUT_DIR/${base_path}.tmpl"

    echo "    $relative -> ${base_path}.tmpl"

    # Create output directory if needed
    mkdir -p "$(dirname "$output")"

    # Expand template (theme variables only, preserving chezmoi syntax)
    expand_template "$template" > "$output"
done

# Apply chezmoi and reload applications (uncomment when ready)
# echo "==> Applying chezmoi..."
# chezmoi apply

# ============================================================================
# Reload Applications
# ============================================================================

echo "==> Reloading applications..."

# Reload Hyprland
# if pgrep -x hyprland >/dev/null; then
#     hyprctl reload
#     echo "    Hyprland reloaded"
# fi

# Restart Waybar
# if pgrep -x waybar >/dev/null; then
#     killall waybar 2>/dev/null || true
#     waybar & disown
#     echo "    Waybar restarted"
# fi

# Reload Mako
# if pgrep -x mako >/dev/null; then
#     makoctl reload
#     echo "    Mako reloaded"
# fi

echo "âœ“ Theme switched to: $THEME"
