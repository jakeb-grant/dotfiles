name: Build Arch ISO

on:
  push:
    branches: [ main, master ]
    paths:
      - 'archiso/**'
      - 'dot_config/**'
      - 'dot_bashrc'
      - '.chezmoi.toml.tmpl'
      - '.github/workflows/build-iso.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a release'
        required: false
        type: boolean
        default: false
      fast_build:
        description: 'Use fast build (larger ISO, faster build)'
        required: false
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update system and install dependencies
      run: |
        pacman-key --init
        pacman-key --populate archlinux
        pacman -Syu --noconfirm --disable-download-timeout
        pacman -S --noconfirm --disable-download-timeout archiso git sudo grub

    - name: Validate package lists
      run: |
        echo "Ensuring package databases are synchronized..."
        pacman -Sy

        INVALID_PACKAGES=""

        # Validate live ISO packages
        echo ""
        echo "Validating packages in archiso/packages.x86_64 (live ISO)..."
        while IFS= read -r package; do
          # Skip empty lines and comments
          if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
            continue
          fi

          # Check if package exists in repositories
          if ! pacman -Si "$package" &>/dev/null; then
            echo "❌ Invalid package: $package"
            INVALID_PACKAGES="$INVALID_PACKAGES $package"
          else
            echo "✓ Valid package: $package"
          fi
        done < archiso/packages.x86_64

        # Validate target system packages
        echo ""
        echo "Validating packages in archiso/target-packages.x86_64 (installed system)..."
        while IFS= read -r package; do
          # Skip empty lines and comments
          if [[ -z "$package" ]] || [[ "$package" =~ ^# ]]; then
            continue
          fi

          # Check if package exists in repositories
          if ! pacman -Si "$package" &>/dev/null; then
            echo "❌ Invalid package: $package"
            INVALID_PACKAGES="$INVALID_PACKAGES $package"
          else
            echo "✓ Valid package: $package"
          fi
        done < archiso/target-packages.x86_64

        if [[ -n "$INVALID_PACKAGES" ]]; then
          echo ""
          echo "ERROR: The following packages were not found in the repositories:"
          echo "$INVALID_PACKAGES"
          echo ""
          echo "Please fix the package names in the package lists"
          exit 1
        fi

        echo ""
        echo "All packages validated successfully!"

    - name: Prepare build environment
      run: |
        # Copy dotfiles to ISO
        mkdir -p archiso/airootfs/root/dotfiles
        cp -r dot_config archiso/airootfs/root/dotfiles/
        cp dot_bashrc archiso/airootfs/root/dotfiles/
        cp .chezmoi.toml.tmpl archiso/airootfs/root/dotfiles/

        # Copy target package list for installer
        cp archiso/target-packages.x86_64 archiso/airootfs/root/

        # Set correct permissions
        chmod +x archiso/airootfs/usr/local/bin/installer.sh
        chmod +x archiso/profiledef.sh

    - name: Select build profile
      run: |
        if [[ "${{ github.event.inputs.fast_build }}" == "true" ]]; then
          echo "Using fast build profile for quicker builds"
          cp archiso/profiledef-fast.sh archiso/profiledef.sh
        else
          echo "Using standard build profile with better compression"
        fi

    - name: Build ISO
      run: |
        mkarchiso -v -w work -o out archiso

    - name: Get ISO information
      id: iso_info
      run: |
        ISO_FILE=$(ls out/*.iso | head -1)
        ISO_NAME=$(basename "$ISO_FILE")
        ISO_SIZE=$(du -h "$ISO_FILE" | cut -f1)
        echo "iso_file=$ISO_FILE" >> $GITHUB_OUTPUT
        echo "iso_name=$ISO_NAME" >> $GITHUB_OUTPUT
        echo "iso_size=$ISO_SIZE" >> $GITHUB_OUTPUT
        echo "ISO Name: $ISO_NAME"
        echo "ISO Size: $ISO_SIZE"

    - name: Calculate checksums
      id: checksums
      run: |
        cd out
        ISO_NAME="${{ steps.iso_info.outputs.iso_name }}"
        sha256sum "$ISO_NAME" > "$ISO_NAME.sha256"
        md5sum "$ISO_NAME" > "$ISO_NAME.md5"
        echo "SHA256: $(cat $ISO_NAME.sha256)"
        echo "MD5: $(cat $ISO_NAME.md5)"

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: hyprland-minimal-iso
        path: |
          out/*.iso
          out/*.sha256
          out/*.md5
        retention-days: 7

    - name: Create Release
      if: github.event.inputs.release == 'true' && github.ref == 'refs/heads/main'
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: iso-${{ github.run_number }}
        name: Hyprland Minimal ISO Build ${{ github.run_number }}
        body: |
          ## Hyprland Minimal ISO

          **Size:** ${{ steps.iso_info.outputs.iso_size }}

          ### Features
          - Minimal Hyprland desktop environment
          - Gum-based interactive installer
          - UEFI-only support
          - Optional LUKS encryption
          - Automated network configuration
          - Chezmoi dotfile management
          - GRUB bootloader

          ### Checksums
          See attached `.sha256` and `.md5` files for verification.

          ### Installation
          1. Write ISO to USB using `dd` or Rufus
          2. Boot from USB in UEFI mode
          3. Run `installer` to start the installation process

        draft: false
        prerelease: false
        files: |
          out/*.iso
          out/*.sha256
          out/*.md5